
<!DOCTYPE html> 
<!--
	Noam's theme, based on Readnik scriptogr.am theme
-->
<html lang="en">
<head>
  <title>Noam Ross | Improved R Profiling Summaries</title>
  <meta name="description" content=" " />
  <meta name="author" content="Noam Ross">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="ROBOTS" content="INDEX,FOLLOW">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <meta property="og:url" content="">
  <meta property="og:site_name" content="Noam Ross">
  <link rel="icon" type="image/x-icon" href="/assets/themes/noamblog/atom.ico">
  <link href="/assets/themes/noamblog/css/style.css" rel="stylesheet" type="text/css" media="all">
  <link href="http://feeds.feedburner.com/noamross" rel="alternate" type="application/rss+xml" title="Noam Ross" />
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30394461-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
 </script>
 <script type="text/javascript"> 
    function typeset() {
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
    function disqus_config() {
      this.callbacks.onNewComment = [typeset];
      this.callbacks.onInit = [typeset];
    }
  </script>
  <script src="http://cachedcommons.org/javascripts/text/prettify-min.js" type="text/javascript"></script>
  <script src="http://cachedcommons.org/javascripts/text/showdown-min.js" type="text/javascript"></script>
  <script src="http://cachedcommons.org/javascripts/jquery/jquery.disqus.js" type="text/javascript"></script>
  <script type="text/javascript" src="/assets/themes/noamblog/app.js"></script>  
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>
  <script type="text/x-mathjax-config">  MathJax.Hub.Config({ "HTML-CSS": { availableFonts: ["TeX"], webfont: [null] }} ); </script>
  <script type="text/x-mathjax-config">  MathJax.Hub.Config({ TeX: { extensions: ["autobold.js"] }} ); </script>
  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">stLight.options({publisher: "4376beef-ffcc-441e-a877-904acf7f379b", theme:'8', onhover:false, doNotHash:true, doNotCopy:true, hashAddressBar:false}); </script>
  <script type="text/javascript">
      function chgifr(url, iframe)  {
          document.getElementById(iframe).src = url;
      }
  </script>
  <script type="text/javascript">
      function showhide(id) {
           var e = document.getElementById(id);
           if(e.style.display == 'block')
              e.style.display = 'none';
           else
              e.style.display = 'block';
        }
  </script>
</head>
<body>
<div class="wrapper">
  <div class="blog">
 
      <div id="menu" class="menu-top">
        <div class="blog-info">
          <h1><a href="/index.html">Noam Ross</a></h1>
          <div class="blog-description">
           <h2>Real-time research in ecology, economics, and sustainability</h2>
          </div>
         </div>
          <div class="pages">
            
            <!-- Lockerz Share BEGIN -->
            <a class="a2a_dd" href="http://www.addtoany.com/share_save" tile"Share this Page"><span class="shareicon"><span class="hide">Share</span></span></a>
            <script type="text/javascript">
            var a2a_config = a2a_config || {};
            a2a_config.onclick = 0;
            a2a_config.show_title = 1;
            a2a_config.color_main = "FFFFFF";
            a2a_config.color_border = "FFFFFF";
            a2a_config.color_link_text = "45462f";
            a2a_config.color_link_text_hover = "575757";
            a2a_config.prioritize = ["twitter", "facebook", "tumblr", "email", "delicious", "linkedin", "stumbleupon", "google_plus"];
            </script>
            <script type="text/javascript" src="http://static.addtoany.com/menu/page.js"></script>
            <!-- Lockerz Share END -->
            
            <a href="http://feeds.feedburner.com/noamross" title="Subscribe via Feedburner RSS"> <span class="rssicon"> <span class="hide">RSS</span></span></a>
            
             
             
            


  
    
  
    
    	
    	<a href="/about.html">About</a>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
    	
    	<a href="/connect.html">Connect</a>
    	
    
  
    
  
    
    	
    	<a href="/index.html">Blog</a>
    	
    
  
    
  
    
  
    
    	
    	<a href="/publications.html">Publications</a>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
    	
    	<a href="/tags.html">Topics</a>
    	
    
  
    
  



            
        </div>
      </div>

      <div class="container">

        <div class="content">
          
<div id="headblock">
<h1 id="page.title"><a href="/blog/2013/5/2/improved-r-profiling-summaries.html">Improved R Profiling Summaries</a></h1>
<p>by <em>Noam Ross</em>, 02 May 2013</p>
<hr />
</div>
<div class="contenttext"><p><p>In my <a href="http://www.noamross.net/blog/2013/4/25/faster-talk.html">last post</a> I mentioned that I had improved on R’s <code>summaryRprof()</code> function with a custom function called <code>proftable()</code>. I’ve updated <code>proftable()</code> to take advantage of R 3.0.0’s ability to record line numbers while profiling. I’ve put it on github – you can get it <a href="https://github.com/noamross/noamtools/blob/master/R/proftable.R">there</a> or below.</p>
<p><code>proftable</code> reads in a file generated by <code>Rprof()</code> and creates an easy-to read table of the most time-consuming calls in your code, ordered from most time-consuming to least. Unlike <code>summaryRprof()</code>, it prints the <em>entire call stack</em>, so you can trace the origin of the time hogs. To make this easier to read, I lop off the “parent stack” common to all of the function calls, and display it just once, below the table. Here’s some example output:</p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">Rprof</span>(<span class="st">&quot;profile1.out&quot;</span>, <span class="dt">line.profiling=</span><span class="ot">TRUE</span>)
&gt;<span class="st"> </span><span class="kw">source</span>(<span class="st">&quot;http://pastebin.com/download.php?i=KjdkSVZq&quot;</span>)
&gt;<span class="st"> </span><span class="kw">Rprof</span>(<span class="ot">NULL</span>)
&gt;<span class="st"> </span><span class="kw">proftable</span>(<span class="st">&quot;profile1.out&quot;</span>, <span class="dt">lines=</span><span class="dv">10</span>)

 PctTime Call                                                      
 <span class="fl">20.47</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame                            </span>
  <span class="fl">9.73</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame &gt; [ &gt; [.factor             </span>
  <span class="fl">8.72</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame &gt; [ &gt; [.factor &gt; NextMethod</span>
  <span class="fl">8.39</span>   ==<span class="st"> </span><span class="er">&gt;</span><span class="st"> </span>Ops.factor                                           
  <span class="fl">5.37</span>   ==<span class="st">                                                        </span>
<span class="st">  </span><span class="fl">5.03</span>   ==<span class="st"> </span><span class="er">&gt;</span><span class="st"> </span>Ops.factor &gt;<span class="st"> </span>noNA.levels &gt;<span class="st"> </span>levels                    
  <span class="fl">4.70</span>   ==<span class="st"> </span><span class="er">&gt;</span><span class="st"> </span>Ops.factor &gt;<span class="st"> </span>NextMethod                              
  <span class="fl">4.03</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame &gt; [ &gt; [.factor &gt; levels    </span>
  <span class="fl">4.03</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame &gt; dim                      </span>
  <span class="fl">3.36</span>   <span class="dv">1</span><span class="co">#17 &gt; [ &gt; 1#17 &gt; [.data.frame &gt; length                   </span>

<span class="co">#File 1: http://pastebin.com/download.php?i=KjdkSVZq</span>

Parent Call:<span class="st"> </span>source &gt;<span class="st"> </span>withVisible &gt;<span class="st"> </span>eval &gt;<span class="st"> </span>eval &gt;

Total Time:<span class="st"> </span><span class="fl">5.96</span> seconds
Percent of run time represented:<span class="st"> </span><span class="fl">73.8</span> %</code></pre>
<p>Note that the “Parent Call” at the bottom shows some functions which RStudio wrapped my code in. Also, I chose only to display the top 10 time-consuming calls, but <code>proftable</code> told me that those 10 calls represent 73.8% of the run time. I find this display a lot more intuitive than <code>summaryRprof()</code></p>
<p>Here’s the whole function. If you have improvements, <a href="https://github.com/noamross/noamtools/blob/master/R/proftable.R">fork it on github</a>:</p>
<pre class="sourceCode r"><code class="sourceCode r">proftable &lt;-<span class="st"> </span>function(file, <span class="dt">lines=</span><span class="dv">10</span>) {
<span class="co"># require(plyr)</span>
  interval &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">strsplit</span>(<span class="kw">readLines</span>(file, <span class="dv">1</span>), <span class="st">&quot;=&quot;</span>)[[1L]][2L])/<span class="fl">1e+06</span>
  profdata &lt;-<span class="st"> </span><span class="kw">read.table</span>(file, <span class="dt">header=</span><span class="ot">FALSE</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>, <span class="dt">comment.char =</span> <span class="st">&quot;&quot;</span>,
                         <span class="dt">colClasses=</span><span class="st">&quot;character&quot;</span>, <span class="dt">skip=</span><span class="dv">1</span>, <span class="dt">fill=</span><span class="ot">TRUE</span>,
                         <span class="dt">na.strings=</span><span class="st">&quot;&quot;</span>)
  filelines &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">&quot;#File&quot;</span>, profdata[,<span class="dv">1</span>])
  files &lt;-<span class="st"> </span><span class="kw">aaply</span>(<span class="kw">as.matrix</span>(profdata[filelines,]), <span class="dv">1</span>, function(x) {
                        <span class="kw">paste</span>(<span class="kw">na.omit</span>(x), <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>) })
  profdata &lt;-<span class="st"> </span>profdata[-filelines,]
  total.time &lt;-<span class="st"> </span>interval*<span class="kw">nrow</span>(profdata)
  profdata &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(profdata[,<span class="kw">ncol</span>(profdata):<span class="dv">1</span>])
  profdata &lt;-<span class="st"> </span><span class="kw">aaply</span>(profdata, <span class="dv">1</span>, function(x) {
                      <span class="kw">c</span>(x[(<span class="kw">sum</span>(<span class="kw">is.na</span>(x))+<span class="dv">1</span>):<span class="kw">length</span>(x)],
                        x[<span class="kw">seq</span>(<span class="dt">from=</span><span class="dv">1</span>,<span class="dt">by=</span><span class="dv">1</span>,<span class="dt">length=</span><span class="kw">sum</span>(<span class="kw">is.na</span>(x)))])
              })
  stringtable &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">apply</span>(profdata, <span class="dv">1</span>, paste, <span class="dt">collapse=</span><span class="st">&quot; &quot;</span>))
  uniquerows &lt;-<span class="st"> </span><span class="kw">strsplit</span>(<span class="kw">names</span>(stringtable), <span class="st">&quot; &quot;</span>)
  uniquerows &lt;-<span class="st"> </span><span class="kw">llply</span>(uniquerows, function(x) <span class="kw">replace</span>(x, <span class="kw">which</span>(x==<span class="st">&quot;NA&quot;</span>), <span class="ot">NA</span>))
  <span class="kw">dimnames</span>(stringtable) &lt;-<span class="st"> </span><span class="ot">NULL</span>
  stacktable &lt;-<span class="st"> </span><span class="kw">ldply</span>(uniquerows, function(x) x)
  stringtable &lt;-<span class="st"> </span>stringtable/<span class="kw">sum</span>(stringtable)*<span class="dv">100</span>
  stacktable &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">PctTime=</span>stringtable[], stacktable)
  stacktable &lt;-<span class="st"> </span>stacktable[<span class="kw">order</span>(stringtable, <span class="dt">decreasing=</span><span class="ot">TRUE</span>),]
  <span class="kw">rownames</span>(stacktable) &lt;-<span class="st"> </span><span class="ot">NULL</span>
  stacktable &lt;-<span class="st"> </span><span class="kw">head</span>(stacktable, lines)
  na.cols &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(stacktable, function(x) <span class="kw">all</span>(<span class="kw">is.na</span>(x))))
  stacktable &lt;-<span class="st"> </span>stacktable[-na.cols]
  parent.cols &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(stacktable, function(x) <span class="kw">length</span>(<span class="kw">unique</span>(x)))==<span class="dv">1</span>)
  parent.call &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">paste</span>(stacktable[<span class="dv">1</span>,parent.cols], <span class="dt">collapse =</span> <span class="st">&quot; &gt; &quot;</span>),<span class="st">&quot; &gt;&quot;</span>)
  stacktable &lt;-<span class="st"> </span>stacktable[,-parent.cols]
  calls &lt;-<span class="st"> </span><span class="kw">aaply</span>(<span class="kw">as.matrix</span>(stacktable[<span class="dv">2</span>:<span class="kw">ncol</span>(stacktable)]), <span class="dv">1</span>, function(x) {
                   <span class="kw">paste</span>(<span class="kw">na.omit</span>(x), <span class="dt">collapse=</span> <span class="st">&quot; &gt; &quot;</span>)
                     })
  stacktable &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">PctTime=</span>stacktable$PctTime, <span class="dt">Call=</span>calls)
  frac &lt;-<span class="st"> </span><span class="kw">sum</span>(stacktable$PctTime)
  <span class="kw">attr</span>(stacktable, <span class="st">&quot;total.time&quot;</span>) &lt;-<span class="st"> </span>total.time
  <span class="kw">attr</span>(stacktable, <span class="st">&quot;parent.call&quot;</span>) &lt;-<span class="st"> </span>parent.call
  <span class="kw">attr</span>(stacktable, <span class="st">&quot;files&quot;</span>) &lt;-<span class="st"> </span>files
  <span class="kw">attr</span>(stacktable, <span class="st">&quot;total.pct.time&quot;</span>) &lt;-<span class="st"> </span>frac
  <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">print</span>(stacktable, <span class="dt">row.names=</span><span class="ot">FALSE</span>, <span class="dt">right=</span><span class="ot">FALSE</span>, <span class="dt">digits=</span><span class="dv">3</span>)
  <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="kw">paste</span>(files, <span class="dt">collapse=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))
  <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Parent Call:&quot;</span>, parent.call))
  <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">Total Time:&quot;</span>, total.time, <span class="st">&quot;seconds</span><span class="ch">\n</span><span class="st">&quot;</span>))
  <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;Percent of run time represented: &quot;</span>, <span class="kw">format</span>(frac, <span class="dt">digits=</span><span class="dv">3</span>)), <span class="st">&quot;%&quot;</span>)

  <span class="kw">invisible</span>(stacktable)
}</code></pre></p></div>
<ul class="tags">
  
    <li><strong>Tags: </strong></li>
    
    <li><a href="/tags.html#R-ref">R</a></li>
    
    <li><a href="/tags.html#optimization-ref">optimization</a></li>
      
</ul>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'noamrossgh'; // required: replace example with your forum shortname
    var disqus_identifier = '/blog/2013/5/2/improved-r-profiling-summaries.html';
    var disqus_url = 'http://www.noamross.net/blog/2013/5/2/improved-r-profiling-summaries.html';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>





<div class="noprint"><hr />
<p> <strong>Previous Post</strong>: <em><a href="/blog/2013/4/25/faster-talk.html">FasteR! HigheR! StrongeR! - A Guide to Speeding Up R Code for Busy People</a></em> </p>
<p> <strong>Next Post</strong>: <em><a href="/blog/2013/5/23/robert-hijmans-on-spatial-data-analysis.html">Robert Hijmans on Spatial Data Analysis</a></em> </p></div>



        </div>
    

      </div>
      
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="/assets/themes/noamblog/footnote-links.js"></script>
<script type="text/javascript">$('div.contenttext').footnoteLinks();</script>
</body>
</html>
