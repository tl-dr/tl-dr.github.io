
<!DOCTYPE html> 
<!--
	Noam's theme, based on Readnik scriptogr.am theme
-->
<html lang="en">
<head>
  <title>Noam Ross | Debugging Tools in R with Michael Hannon</title>
  <meta name="description" content=" " />
  <meta name="author" content="Noam Ross">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="ROBOTS" content="INDEX,FOLLOW">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <meta property="og:url" content="">
  <meta property="og:site_name" content="Noam Ross">
  <link rel="icon" type="image/x-icon" href="/assets/themes/noamblog/atom.ico">
  <link href="/assets/themes/noamblog/css/style.css" rel="stylesheet" type="text/css" media="all">
  <link href="http://feeds.feedburner.com/noamross" rel="alternate" type="application/rss+xml" title="Noam Ross" />
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30394461-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
 </script>
 <script type="text/javascript"> 
    function typeset() {
      MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
    function disqus_config() {
      this.callbacks.onNewComment = [typeset];
      this.callbacks.onInit = [typeset];
    }
  </script>
  <script src="http://cachedcommons.org/javascripts/text/prettify-min.js" type="text/javascript"></script>
  <script src="http://cachedcommons.org/javascripts/text/showdown-min.js" type="text/javascript"></script>
  <script src="http://cachedcommons.org/javascripts/jquery/jquery.disqus.js" type="text/javascript"></script>
  <script type="text/javascript" src="/assets/themes/noamblog/app.js"></script>  
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>
  <script type="text/x-mathjax-config">  MathJax.Hub.Config({ "HTML-CSS": { availableFonts: ["TeX"], webfont: [null] }} ); </script>
  <script type="text/x-mathjax-config">  MathJax.Hub.Config({ TeX: { extensions: ["autobold.js"] }} ); </script>
  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">stLight.options({publisher: "4376beef-ffcc-441e-a877-904acf7f379b", theme:'8', onhover:false, doNotHash:true, doNotCopy:true, hashAddressBar:false}); </script>
  <script type="text/javascript">
      function chgifr(url, iframe)  {
          document.getElementById(iframe).src = url;
      }
  </script>
  <script type="text/javascript">
      function showhide(id) {
           var e = document.getElementById(id);
           if(e.style.display == 'block')
              e.style.display = 'none';
           else
              e.style.display = 'block';
        }
  </script>
</head>
<body>
<div class="wrapper">
  <div class="blog">
 
      <div id="menu" class="menu-top">
        <div class="blog-info">
          <h1><a href="/index.html">Noam Ross</a></h1>
          <div class="blog-description">
           <h2>Real-time research in ecology, economics, and sustainability</h2>
          </div>
         </div>
          <div class="pages">
            
            <!-- Lockerz Share BEGIN -->
            <a class="a2a_dd" href="http://www.addtoany.com/share_save" tile"Share this Page"><span class="shareicon"><span class="hide">Share</span></span></a>
            <script type="text/javascript">
            var a2a_config = a2a_config || {};
            a2a_config.onclick = 0;
            a2a_config.show_title = 1;
            a2a_config.color_main = "FFFFFF";
            a2a_config.color_border = "FFFFFF";
            a2a_config.color_link_text = "45462f";
            a2a_config.color_link_text_hover = "575757";
            a2a_config.prioritize = ["twitter", "facebook", "tumblr", "email", "delicious", "linkedin", "stumbleupon", "google_plus"];
            </script>
            <script type="text/javascript" src="http://static.addtoany.com/menu/page.js"></script>
            <!-- Lockerz Share END -->
            
            <a href="http://feeds.feedburner.com/noamross" title="Subscribe via Feedburner RSS"> <span class="rssicon"> <span class="hide">RSS</span></span></a>
            
             
             
            


  
    
  
    
    	
    	<a href="/about.html">About</a>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
    	
    	<a href="/connect.html">Connect</a>
    	
    
  
    
  
    
    	
    	<a href="/index.html">Blog</a>
    	
    
  
    
  
    
  
    
    	
    	<a href="/publications.html">Publications</a>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
    	
    	<a href="/tags.html">Topics</a>
    	
    
  
    
  



            
        </div>
      </div>

      <div class="container">

        <div class="content">
          
<div id="headblock">
<h1 id="page.title"><a href="/blog/2013/4/18/r-debug-tools.html">Debugging Tools in R with Michael Hannon</a></h1>
<p>by <em>Noam Ross</em>, 18 April 2013</p>
<hr />
</div>
<div class="contenttext"><p><p><em>Today at <a href="http://www.noamross.net/davis-r-users-group.html">Davis R Users’ Group</a>, Michael Hannon gave a great talk on how to use R’s native debugging functions. Here are his notes and code.</em></p>
<h2 id="introduction">Introduction</h2>
<p>This is a discussion of debugging techniques in R. It is based on a paper by Roger Peng, now at Johns Hopkins University (<a href="http://www.biostat.jhsph.edu/~rpeng/docs/R-debug-tools.pdf">http://www.biostat.jhsph.edu/~rpeng/docs/R-debug-tools.pdf</a>)</p>
<h3 id="focus-on-five-functions">Focus on five functions:</h3>
<ul>
<li>traceback</li>
<li>debug</li>
<li>browser</li>
<li>trace</li>
<li>recover</li>
</ul>
<h3 id="severity-level">Severity level</h3>
<p>R mainly uses two ways of reporting a problem:</p>
<ul>
<li>Warning: Does not stop execution</li>
<li>Error: More serious – <em>does</em> stop execution</li>
</ul>
<p>Example of warning:</p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span>zzz &lt;-<span class="st"> </span><span class="kw">log</span>(-<span class="dv">1</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Warning: NaNs produced</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span>zzz</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## [1] NaN</code></pre>
<p>Example of error:</p>
<pre class="sourceCode r"><code class="sourceCode r">#### Define a function to be used/abused later on.
message &lt;-<span class="st"> </span>function(x) {
  if(x &gt;<span class="st"> </span><span class="dv">0</span>)
    <span class="kw">print</span>(<span class="st">&quot;Hello&quot;</span>)
  else
    <span class="kw">print</span>(<span class="st">&quot;Goodbye&quot;</span>)
  }</code></pre>
<p>Here’s the function in action:</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">42</span>
<span class="kw">message</span>(x)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## [1] &quot;Hello&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">
x &lt;-<span class="st"> </span><span class="kw">log</span>(-<span class="dv">1</span>)  #### Produces warning but does not stop</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Warning: NaNs produced</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">message</span>(x)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Error: missing value where TRUE/FALSE needed</code></pre>
<h3 id="debugging-tools">Debugging tools</h3>
<h3 id="print-call-stack-with-traceback">Print “call stack” with <code>traceback</code></h3>
<p>How did we get here? That is, what sequence of function calls led us to the point where an error occurred? Answer: the <code>traceback</code> function can tell us. Here’s an example:</p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st">   </span><span class="kw">message</span>(<span class="kw">log</span>(-<span class="dv">1</span>))
Error in if (x &gt;<span class="st"> </span><span class="dv">0</span>) <span class="kw">print</span>(<span class="st">&quot;Hello&quot;</span>) else <span class="kw">print</span>(<span class="st">&quot;Goodbye&quot;</span>) :<span class="st"> </span>
<span class="st">  </span>missing value where <span class="ot">TRUE</span>/<span class="ot">FALSE</span> needed
In addition:<span class="st"> </span>Warning message:
In <span class="kw">log</span>(-<span class="dv">1</span>) :<span class="st"> </span>NaNs produced
&gt;<span class="st"> </span>
<span class="er">&gt;</span><span class="st">   </span><span class="kw">traceback</span>()
<span class="dv">1</span>:<span class="st"> </span><span class="kw">message</span>(<span class="kw">log</span>(-<span class="dv">1</span>))</code></pre>
<p>It’s hard to get “lost” when you’ve got only one function to begin with, but real life is more complicated. THe following isn’t exactly “real-life” either, but it better illustrates the point.</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function(x) {
    r &lt;-<span class="st"> </span>x -<span class="st"> </span><span class="kw">g</span>(x)
    r
}
g &lt;-<span class="st"> </span>function(y) {
    r &lt;-<span class="st"> </span>y *<span class="st"> </span><span class="kw">h</span>(y)
    r
}
h &lt;-<span class="st"> </span>function(z) {
    r &lt;-<span class="st"> </span><span class="kw">log</span>(z)
    if (r &lt;<span class="st"> </span><span class="dv">10</span>) 
        r^<span class="dv">2</span> else r^<span class="dv">3</span>
}</code></pre>
<p>You can probably guess that the log function is going to be the trouble maker, but let’s see what happens.</p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">f</span>(-<span class="dv">1</span>)
Error in if (r &lt;<span class="st"> </span><span class="dv">10</span>) r^<span class="dv">2</span> else r^<span class="dv">3</span> :<span class="st"> </span>missing value where <span class="ot">TRUE</span>/<span class="ot">FALSE</span> needed
In addition:<span class="st"> </span>Warning message:
In <span class="kw">log</span>(z) :<span class="st"> </span>NaNs produced
&gt;<span class="st"> </span><span class="kw">traceback</span>()
<span class="dv">3</span>:<span class="st"> </span><span class="kw">h</span>(y) at <span class="co">#2</span>
<span class="dv">2</span>:<span class="st"> </span><span class="kw">g</span>(x) at <span class="co">#2</span>
<span class="dv">1</span>:<span class="st"> </span><span class="kw">f</span>(-<span class="dv">1</span>)
&gt;<span class="st"> </span></code></pre>
<p>This shows that we started out with a call to f, which generated a call to g, which generated a call to h. The error evidently occurred at statement #2 of h. Note, by the way, the following trick to view the line numbers in a function:</p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">as.list</span>(<span class="kw">body</span>(h))
[[<span class="dv">1</span>]]
<span class="st">`</span><span class="dt">{</span><span class="st">`</span>

[[<span class="dv">2</span>]]
r &lt;-<span class="st"> </span><span class="kw">log</span>(z)

[[<span class="dv">3</span>]]
if (r &lt;<span class="st"> </span><span class="dv">10</span>) r^<span class="dv">2</span> else r^<span class="dv">3</span></code></pre>
<p>I.e., statement #2 of h is, as expected, the one that involves the log function.</p>
<h3 id="the-debug-function">The <code>debug</code> function</h3>
<p>The <code>traceback</code> function helps us to locate the error, but then what do we do? Ideally, we could just stare at our code, then find and fix the error. But it often helps to have some detailed information as to what was going on in our code at the time of the error.</p>
<p>The <code>debug</code> function allows us to do just that. We can step through our code, a line at a time, and examine variables along the way.</p>
<p>The syntax is:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">debug</span>(function-name)</code></pre>
<p>and to turn off debugging we use:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">undebug</span>(function-name)</code></pre>
<p>(I.e., we might find and fix a problem on the third pass through a loop of 10000 iterations, after which we no longer need or want to debug for the other 9997 times through the loop.)</p>
<p>Here’s an example. The mathematical background is that we have N observations of a random variable that we assume to be normally distributed but with an unknown mean and variance. To estimate the parameters we need to compute the sum of the squared differences from the mean:</p>
<p><span class="math">\[
SS = \sum_{n=1}^{N}(x_n - \mu)^2
\]</span></p>
<p>(Details at: <a href="http://en.wikipedia.org/wiki/Normal_distribution#Estimation_of_parameters">http://en.wikipedia.org/wiki/Normal_distribution#Estimation_of_parameters</a>)</p>
<p>Here we’ll focus on just one part of the calculation, computing the sum of the squared differences. Here’s an R function that will do that for us:</p>
<pre class="sourceCode r"><code class="sourceCode r">SS &lt;-<span class="st"> </span>function(mu, x) {
    d &lt;-<span class="st"> </span>x -<span class="st"> </span>mu
    d2 &lt;-<span class="st"> </span>d^<span class="dv">2</span>
    ss &lt;-<span class="st"> </span><span class="kw">sum</span>(d2)
    ss
}</code></pre>
<p>You can probably see that the function could be written much more compactly, but we’ll string it out for purposes of illustration.</p>
<p>Let’s generate some points from a Normal(0,1) distribution:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">314159</span>)  <span class="co"># Set the RNG seed so results are reproducible</span>
xPoints &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)</code></pre>
<p>Let’s run SS to get a feel for its behavior:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## [1] 202.5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">muTest &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(-<span class="dv">5</span>:<span class="dv">5</span>)
SSTest &lt;-<span class="st"> </span><span class="kw">sapply</span>(muTest, SS, xPoints)
<span class="kw">plot</span>(muTest, SSTest)</code></pre>
<div class="figure">
<img src="http://dl.dropbox.com/u/3356641/blogstuff/exerciseSS.png" />
</div>
<p>Now suppose we want to examine in detail the behavior of the SS function. First, we flag the function for debugging:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">debug</span>(SS)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
debugging in:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
debug at <span class="co">#1: {</span>
    d &lt;-<span class="st"> </span>x -<span class="st"> </span>mu
    d2 &lt;-<span class="st"> </span>d^<span class="dv">2</span>
    ss &lt;-<span class="st"> </span><span class="kw">sum</span>(d2)
    ss
<span class="er">}</span>
Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
debug at <span class="co">#2: d &lt;- x - mu</span>
Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
debug at <span class="co">#3: d2 &lt;- d^2</span>
Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
debug at <span class="co">#4: ss &lt;- sum(d2)</span>
Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
debug at <span class="co">#5: ss</span>
Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
exiting from:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
[<span class="dv">1</span>] <span class="fl">202.482</span></code></pre>
<p>This isn’t a particularly interesting use of the debugger, as all we did was to step through the function a line at a time, using the ‘n’ command, but it does illustrate some of the basic ideas:</p>
<ul>
<li><p>First, when we enter the SS function, the function itself is printed, and execution <strong>stops</strong>.</p></li>
<li><p>The R prompt, ‘&gt;’, changes to ‘Browse[<number>]&gt;’</p></li>
</ul>
<p>There are four basic commands you can use in the debugger:</p>
<ul>
<li><p><strong>n</strong>: execute the current line of code and step to the next</p></li>
<li><p><strong>c</strong>: continue execution without stopping again</p></li>
<li><p><strong>Q</strong>: quit debugging completely and to back to the top-level R prompt</p></li>
<li><p><strong>where</strong>: similar to calling traceback</p></li>
</ul>
<p>You can execute any R code at the “Browse” prompt, i.e., not just code related to the function. The most important example of this is probably the ls() command, which shows us what objects are defined in the current environment (i.e., within a given function, for instance):</p>
<pre class="sourceCode r"><code class="sourceCode r">    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">ls</span>()
    [<span class="dv">1</span>] <span class="st">&quot;mu&quot;</span> <span class="st">&quot;x&quot;</span> 

    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>mu
    [<span class="dv">1</span>] <span class="dv">1</span>

    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">head</span>(x)
    [<span class="dv">1</span>] -<span class="fl">0.79928868</span> -<span class="fl">0.73009689</span>  <span class="fl">1.43687692</span>  <span class="fl">0.30502316</span> -<span class="fl">0.39728401</span>
    [<span class="dv">6</span>]  <span class="fl">0.08889039</span></code></pre>
<p>But the facility is completely general. Here’s a trivial example of defining something unrelated to the current function:</p>
<pre class="sourceCode r"><code class="sourceCode r">    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>zzz &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">64</span>)
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>zzz
    [<span class="dv">1</span>] <span class="dv">8</span></code></pre>
<p>Here’s another, somewhat more interesting session with SS:</p>
<pre class="sourceCode r"><code class="sourceCode r">    &gt;<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
    debugging in:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
    debug at <span class="co">#1: {</span>
        d &lt;-<span class="st"> </span>x -<span class="st"> </span>mu
        d2 &lt;-<span class="st"> </span>d^<span class="dv">2</span>
        ss &lt;-<span class="st"> </span><span class="kw">sum</span>(d2)
        ss
    <span class="er">}</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
    debug at <span class="co">#2: d &lt;- x - mu</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
    debug at <span class="co">#3: d2 &lt;- d^2</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>d[<span class="dv">1</span>]  ## Print the value of the first element of d
    [<span class="dv">1</span>] -<span class="fl">1.799289</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
    debug at <span class="co">#4: ss &lt;- sum(d2)</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">hist</span>(d2)
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>n
    debug at <span class="co">#5: ss</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">print</span>(ss)
    [<span class="dv">1</span>] <span class="fl">202.482</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">ls</span>()
    [<span class="dv">1</span>] <span class="st">&quot;d&quot;</span>  <span class="st">&quot;d2&quot;</span> <span class="st">&quot;mu&quot;</span> <span class="st">&quot;ss&quot;</span> <span class="st">&quot;x&quot;</span> 
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>where
    where <span class="dv">1</span>:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
    
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>y &lt;-<span class="st"> </span>x^<span class="dv">2</span>  ## Create new object
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">ls</span>()
    [<span class="dv">1</span>] <span class="st">&quot;d&quot;</span>  <span class="st">&quot;d2&quot;</span> <span class="st">&quot;mu&quot;</span> <span class="st">&quot;ss&quot;</span> <span class="st">&quot;x&quot;</span>  <span class="st">&quot;y&quot;</span> 
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span><span class="kw">head</span>(y)
    [<span class="dv">1</span>] <span class="fl">0.638862388</span> <span class="fl">0.533041463</span> <span class="fl">2.064615286</span> <span class="fl">0.093039131</span> <span class="fl">0.157834589</span>
    [<span class="dv">6</span>] <span class="fl">0.007901501</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>c  ## Execute the rest of the function w/o stopping
    exiting from:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
    [<span class="dv">1</span>] <span class="fl">202.482</span>

    &gt;<span class="st"> </span><span class="kw">undebug</span>(SS)  ## No need for further debugging</code></pre>
<p>Note the explicit use of the <code>print</code> function in the above. At an interactive prompt, R will “autoprint” the value of a variable when it is used, so use of the <code>print</code> function is optional. But what if, for instance, you had <code>n</code> as a parameter in your function? Then to examine <code>n</code> you’d need to say explicitly:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(n)</code></pre>
<p>One final thing: if you want to debug a function, you have to say so <strong>before</strong> you call the function. This is more or less obvious.</p>
<p>Perhaps not so obvious is the fact that you can flag functions for debugging “on the fly”. I.e., you can turn on debugging for other functions while you’re in the process of debugging a given function. Example later.</p>
<h3 id="explicit-calls-to-browser">Explicit Calls to Browser</h3>
<p>Rather than flagging a function for debugging and then stepping through the function a line at a time, it is sometimes convenient to modify your code in such a way as to trigger debugging at the point where you suspect the trouble lies.</p>
<p>Consider the following modified version of SS, for instance. We might feel confident that the trouble occurs in our function only after <code>d2</code> has been calculated, so we insert a call to the function <code>browser</code> at the point where we want to start, well, browsing.</p>
<pre class="sourceCode r"><code class="sourceCode r">
SS &lt;-<span class="st"> </span>function(mu, x) {
    d &lt;-<span class="st"> </span>x -<span class="st"> </span>mu
    d2 &lt;-<span class="st"> </span>d^<span class="dv">2</span>
    <span class="kw">browser</span>()
    ss &lt;-<span class="st"> </span><span class="kw">sum</span>(d2)
    ss
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">    &gt;<span class="st"> </span><span class="kw">SS</span>(<span class="dv">2</span>, xPoints)
    Called from:<span class="st"> </span><span class="kw">SS</span>(<span class="dv">2</span>, xPoints)
    Browse[<span class="dv">1</span>]&gt;<span class="st"> </span><span class="kw">ls</span>()
    [<span class="dv">1</span>] <span class="st">&quot;d&quot;</span>  <span class="st">&quot;d2&quot;</span> <span class="st">&quot;mu&quot;</span> <span class="st">&quot;x&quot;</span> 
    Browse[<span class="dv">1</span>]&gt;<span class="st"> </span><span class="kw">print</span>(mu)
    [<span class="dv">1</span>] <span class="dv">2</span>
    Browse[<span class="dv">1</span>]&gt;<span class="st"> </span><span class="kw">mean</span>(x)
    [<span class="dv">1</span>] -<span class="fl">0.05553729</span>
    Browse[<span class="dv">1</span>]&gt;<span class="st"> </span>n
    debug at <span class="co">#5: ss &lt;- sum(d2)</span>
    Browse[<span class="dv">2</span>]&gt;<span class="st"> </span>c
    [<span class="dv">1</span>] <span class="fl">513.5895</span></code></pre>
<p>One drawback to this mode of operation is that you have to remember to <em>remove</em> the call to <code>browser</code> before you put the code into production.</p>
<p>One real advantage of this approach is that you can use it to debug “anonymous” functions, as:</p>
<pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">sapply</span>(<span class="dv">1</span>:<span class="dv">50</span>, function_with_no_name {
        .
        .
        .
        <span class="kw">browser</span>()
        .
        .
        .
    })</code></pre>
<h3 id="inserting-code-with-trace">Inserting Code with <code>trace</code></h3>
<p>As with <code>debug</code>, the function <code>trace</code> allows you to debug code, but <code>trace</code> is much more general and sophisticated. The simplest uses of <code>trace</code> don’t appear much different from the corresponding use of <code>debug</code>, although some differences are evident.</p>
<p>The following example is taken from the book <em>Software for Data Analysis</em> by John M. Chambers. Suppose we have defined three functions, called <code>Fn1</code>, <code>Fn2</code>, <code>Fn3</code>. (The details of the function don’t matter for the purposes of this example.) Then we might use <code>trace</code> as follows:</p>
<pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">trace</span>(Fn1, recover)
    <span class="kw">trace</span>(Fn2, <span class="dt">exit =</span> browser)
    <span class="kw">trace</span>(Fn3, browser, <span class="dt">exit =</span> browser)</code></pre>
<p>Here, <code>browser</code> is the same function we saw above. The function <code>recover</code> lets us examine the full sequence of calls that brought us to a given point in our code, and then browse inside <em>any</em> of the functions in the sequence.</p>
<p>After the above calls to <code>trace</code>, all future calls to <code>Fn1</code> will begin with a call to <code>recover()</code>; calls to <code>Fn2</code> will invoke <code>browser()</code> just before the function exits; calls to <code>Fn3</code> will invoke <code>browser()</code> on both entry to the function and exit from the function. (In the case of <code>Fn3</code> we might get tired of stepping through the function and hit <code>c</code> (continue), but stop before we leave the function, juuust to make sure everything is still OK before we lose all the local variables in the function.)</p>
<p>The <code>trace</code> function works by modifying the code of the function, then saving the modified function, and running the modified version when you invoke the function. The original code is not touched, and you can restore the original behavior by executing:</p>
<pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">untrace</span>(Fn1)
    etc.</code></pre>
<p>Here are some examples with our <code>SS</code> function:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">trace</span>(SS, recover)
<span class="kw">SS</span>(<span class="dv">1</span>, xPoints)
<span class="kw">untrace</span>(SS)

<span class="kw">trace</span>(SS, browser)
<span class="kw">SS</span>(<span class="dv">2</span>, xPoints)
<span class="kw">untrace</span>(SS)

<span class="kw">trace</span>(SS, <span class="dt">exit =</span> browser)
<span class="kw">SS</span>(<span class="dv">3</span>, xPoints)
<span class="kw">untrace</span>(SS)</code></pre>
<p>The paper by Roger Peng, mentioned at the beginning of this note, has an example in which he minimizes the negative log-likelihood of a statistical model, using an R function that he calls <code>nLL</code>. The details of the discussion are somewhat complicated and will be omitted here.</p>
<p>The salient point is that the procedure in question involves many iterations, and is plagued by the same problem that we discussed above: the log of a negative number produces a so-called <code>NaN</code> (“not a number”) in <em>some</em> of the iterations. We would hope not to get NaN’s in our calculations, and we might, therefore, want to examine in detail the situations in which a NaN is produced. But there might be tens or hundreds or thousands of iterations, most of which do not generate NaN’s. Stepping through all the iterations would take a lifetime. What to do?</p>
<p>The solution is to trace the function using some of its more sophisticated options:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">trace</span>(<span class="st">&quot;nLL&quot;</span>, <span class="kw">quote</span>(if(<span class="kw">any</span>(<span class="kw">is.nan</span>(lz))) { <span class="kw">browser</span>() }), <span class="dt">at=</span><span class="dv">4</span>, <span class="dt">print=</span>F)</code></pre>
<p>Here:</p>
<ul>
<li><p><code>nLL</code> is the name of the function to be traced</p></li>
<li><p>the stuff inside the <code>quote</code> function is code to be inserted (dynamically) into the nLL function; it could also be just the name of a function (as in our introductory examples)</p></li>
<li><p><code>at</code> is the line number at which to insert the code, which the author determines from <code>as.list(body(nLL))</code> (see above)</p></li>
<li><p><code>print=FALSE</code> just suppresses the printing of a descriptive message</p></li>
</ul>
<p>This is as if we had written:</p>
<pre class="sourceCode r"><code class="sourceCode r">    if(<span class="kw">any</span>(<span class="kw">is.nan</span>(lz))) {
        <span class="kw">browser</span>()
    }</code></pre>
<p>at line 4 of the <code>nLL</code> function.</p>
<p>Here’s a simpler example using the functions we mentioned at the beginning of the discussion:</p>
<pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">trace</span>(h, <span class="kw">quote</span>(if (<span class="kw">is.nan</span>(r)) {
    <span class="kw">browser</span>()
}), <span class="dt">at =</span> <span class="dv">3</span>)
<span class="kw">f</span>(<span class="dv">7</span>)
<span class="kw">f</span>(-<span class="dv">3</span>)
<span class="kw">untrace</span>(f)</code></pre>
<p>Finally, if using the quoted expression for the second argument of <code>trace</code> seems too intimidating. let’s note that <code>trace</code> has an <code>edit</code> argument. If you call trace as:</p>
<pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">trace</span> (someFn, ..., <span class="dt">edit=</span><span class="ot">TRUE</span>)</code></pre>
<p>you will dropped into an editor, where you can edit your code to your heart’s content before the (temporarily modified) function executes. BTW, you can also supply the name of an editor here, as:</p>
<pre class="sourceCode r"><code class="sourceCode r">    <span class="kw">trace</span> (someFn, ..., <span class="dt">edit=</span><span class="st">&quot;/usr/bin/vim&quot;</span>)</code></pre>
<h3 id="editors-addendum-a-quick-way-to-enable-bugging-everywhere"><em>Editor’s Addendum: A quick way to enable bugging everywhere</em></h3>
<p><em>One way to get in the habit of debugging is to drop this into your <code>.Rprofile</code> file or run it at the start of your R session:</em></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">error=</span>utils::recover)</code></pre>
<p><em>This will automatically invoke <code>recover()</code> every time your code gives an error, allowing you to view the stack of function calls and enter the browser mode in any of the functions. For instance:</em></p>
<pre class="sourceCode r"><code class="sourceCode r">&gt;<span class="st"> </span><span class="kw">f</span>(<span class="st">&quot;a&quot;</span>)
Error in <span class="kw">log</span>(z) :<span class="st"> </span>non-numeric argument to mathematical function

Enter a frame number, or <span class="dv">0</span> to exit   

<span class="dv">1</span>:<span class="st"> </span><span class="kw">f</span>(<span class="st">&quot;a&quot;</span>)
<span class="dv">2</span>:<span class="st"> </span><span class="co">#2: g(x)</span>
<span class="dv">3</span>:<span class="st"> </span><span class="co">#2: h(y)</span></code></pre>
<p><em>Now selecting any of these will start browser mode within those functions. If you don’t need to use the browser (for instance, if the source of the error is obvious), just enter <code>0</code> and move on.</em></p></p></div>
<ul class="tags">
  
    <li><strong>Tags: </strong></li>
    
    <li><a href="/tags.html#D-RUG-ref">D-RUG</a></li>
    
    <li><a href="/tags.html#R-ref">R</a></li>
    
    <li><a href="/tags.html#code-ref">code</a></li>
      
</ul>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'noamrossgh'; // required: replace example with your forum shortname
    var disqus_identifier = '/blog/2013/4/18/r-debug-tools.html';
    var disqus_url = 'http://www.noamross.net/blog/2013/4/18/r-debug-tools.html';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>





<div class="noprint"><hr />
<p> <strong>Previous Post</strong>: <em><a href="/blog/2013/4/4/oleary-popbio-presentation.html">Demographic analysis using the `popbio` library and some other fun stuff</a></em> </p>
<p> <strong>Next Post</strong>: <em><a href="/blog/2013/4/24/my-first-publication.html">My first peer-reviewed publication: Economics and Ecology of Open-Access Fisheries</a></em> </p></div>



        </div>
    

      </div>
      
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="/assets/themes/noamblog/footnote-links.js"></script>
<script type="text/javascript">$('div.contenttext').footnoteLinks();</script>
</body>
</html>
